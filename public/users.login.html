<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CineMex</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style-buttons.css" />
  <link rel="stylesheet" href="./style-card.movie.css" />
  <link rel="stylesheet" href="./style-modal.edit.css" />
  <style>
    :root {
      --primary-color: #2196f3;
      --secondary-color: #ff9800;
      --background-color: #0d1117;
      --card-color: #161b22;
      --text-color: #e6edf3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: var(--background-color);
      color: var(--text-color);
      font-family: 'Poppins', sans-serif;
      padding-bottom: 50px;
    }

    .header {
      padding: 30px 0 20px;
      text-align: center;
      background-color: rgba(13, 17, 23, 0.95);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(5px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-left: 30px;
      padding-right: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 20px;
    }

    .movies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 30px;
    }

    .movie-card {
      background-color: var(--card-color);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .movie-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
    }

    .movie-poster {
      position: relative;
      padding-top: 150%;
      background-color: #21262d;
      overflow: hidden;
    }

    .movie-poster img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }

    .movie-card:hover .movie-poster img {
      transform: scale(1.05);
    }

    .movie-info {
      padding: 20px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .movie-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-color);
    }

    .movie-details {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .movie-year {
      background-color: rgba(33, 150, 243, 0.2);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--primary-color);
    }

    .movie-owner {
      display: inline-block;
      background-color: rgba(33, 150, 243, 0.2);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--primary-color);
      margin-bottom: 10px;
    }

    .current-user {
      background-color: rgba(255, 152, 0, 0.2);
      color: var(--secondary-color);
    }

    .movie-description {
      font-size: 0.9rem;
      color: #8b949e;
      margin-bottom: 15px;
    }





    .view-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
      flex: 1;
    }


    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 101;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
      background-color: var(--card-color);
      margin: 10% auto;
      padding: 25px;
      max-width: 500px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      color: var(--text-color);
      overflow-y: auto;
      /* Añadido para permitir el desplazamiento vertical */
      max-height: 80vh;
      /* Añadido para limitar la altura máxima del modal */
    }

    .close {
      color: #8b949e;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close:hover {
      color: var(--text-color);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }

    input,
    textarea {
      width: 100%;
      padding: 12px;
      background-color: #21262d;
      border: 1px solid #30363d;
      border-radius: 5px;
      color: var(--text-color);
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
    }

    @media (max-width: 768px) {
      .movies-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
      }

      .header h1 {
        font-size: 2rem;
      }
    }

    @media (max-width: 480px) {
      .movies-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }

      .header h1 {
        font-size: 1.8rem;
      }

      .movie-info {
        padding: 15px;
      }

      .movie-title {
        font-size: 1rem;
      }

      .header {
        flex-direction: column;
        gap: 15px;
      }
    }

    .header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 20px;
      padding: 10px 20px;
      /* Añade un poco de padding general al header */
    }

    .search-container {
      display: flex;
      align-items: center;
    }

    .search-container input[type="text"] {
      width: 100%;
      padding: 8px;
    }

    .search-container button {
      margin-left: 5px;
    }

    /* Opcional: Estilos para los botones de paginación (si también los quieres morados) */
    .pagination-button {
      padding: 8px 12px;
      margin: 5px;
      border: 1px solid #d1c4e9;
      /* Borde morado claro */
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      background-color: white;
      color: #5e35b1;
      /* Texto morado */
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .pagination-button:hover {
      background-color: #ede7f6;
      /* Morado muy claro al pasar el ratón */
      border-color: #b39ddb;
    }

    .pagination-button.active {
      background-color: #5e35b1;
      /* Morado activo */
      color: white;
      border-color: #5e35b1;
    }

    .pagination-button.active:hover {
      background-color: #4527a0;
      /* Morado activo más oscuro al pasar el ratón */
    }

    .delete-btn {
      background-color: #7b1fa2;
      /* Morado más oscuro (igual al hover de Editar) */
      color: white;
    }

    .delete-btn:hover {
      background-color: #5e35b1;
      /* Morado aún más oscuro al pasar el ratón */
    }

    /* Opcional: Estilos para los botones de paginación */
    .pagination-button {
      padding: 8px 12px;
      margin: 5px;
      border: 1px solid #d1c4e9;
      /* Borde morado claro */
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      background-color: white;
      color: #5e35b1;
      /* Texto morado */
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .pagination-button:hover {
      background-color: #ede7f6;
      /* Morado muy claro al pasar el ratón */
      border-color: #b39ddb;
    }

    .pagination-button.active {
      background-color: #5e35b1;
      /* Morado activo */
      color: white;
      border-color: #5e35b1;
    }

    .pagination-button.active:hover {
      background-color: #4527a0;
      /* Morado activo más oscuro al pasar el ratón */
    }
  </style>
</head>

<body>
  <header class="header" style="display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 20px;">
    <h1>CineMex</h1>
    <div class="search-container" style="display: flex; align-items: center;">
      <input type="text" id="searchInput" placeholder="Buscar películas..." style="width: 100%; padding: 8px;">
      <button id="searchButton" style="margin-left: 5px;">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
    </div>
    <button id="addMovieBtn" class="action-btn add-btn">Agregar Película</button>
  </header>
  </header>

  <div class="container">
    <div class="movies-grid" id="moviesGrid">
      <!-- Las tarjetas de películas se generarán dinámicamente -->
    </div>
    <div id="container-pagination"></div>

    <div id="loader" style="display: none;">Cargando películas...</div>
  </div>

  <div id="movieModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Editar Película</h2>
      <form id="movieForm">
        <input type="hidden" id="movieId">
        <div class="form-group">
          <label for="movieTitle">Título:</label>
          <input type="text" id="title" required>
        </div>
        <div class="form-group">
          <label for="movieYear">Año:</label>
          <input type="number" id="year" min="1900" max="2099" required>
        </div>
        <div class="form-group">
          <label for="movieDirector">Director:</label>
          <input type="text" id="director">
        </div>
        <div class="form-group">
          <label for="movieDescription">Descripción:</label>
          <textarea id="description" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label for="movieGenre">Género:</label>
          <input type="text" id="genre">
        </div>
        <div class="form-group">
          <label for="movieRating">Calificación:</label>
          <input type="number" id="rating" min="0" max="10" step="0.1">
        </div>
        <div class="form-group">
          <label for="movieDuration">Duración (minutos):</label>
          <input type="number" id="duration" min="1">
        </div>
        <div class="form-group">
          <label for="movieLanguage">Idioma:</label>
          <input type="text" id="language">
        </div>
        <div class="form-group">
          <label for="movieCountry">País:</label>
          <input type="text" id="country">
        </div>
        <div class="form-group">
          <label for="movieActors">Actores (separados por coma):</label>
          <input type="text" id="cast">
        </div>
        <div class="form-group">
          <label for="movieImageUrl">URL de la imagen:</label>
          <input type="text" id="imgUrl">
        </div>
        <button type="submit" class="submit-btn">Guardar</button>
      </form>
    </div>
  </div>

  </div>

  <script>
    let allMovies = [];
    let filteredMovies = [];
    let currentPage = 1;
    const moviesPerPage = 8;
    const config = {
      "api": {
        "check_session": "http://localhost:3000/api/auth/check-session",
        "getAllMovies": "http://localhost:3000/api/movies/",
        "addMovie": 'http://localhost:3000/api/movies/agregarpelicula',
        "updateMovie": 'http://localhost:3000/api/movies/actualizar',
        "baseMovie": 'http://localhost:3000/api/movies/',
      }
    }

    // Referencias DOM
    const moviesGrid = document.getElementById('moviesGrid');
    const loader = document.getElementById('loader');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const paginationContainer = document.getElementById('pagination');
    const addMovieBtn = document.getElementById('addMovieBtn');
    const movieModal = document.getElementById('movieModal');
    const closeBtn = document.querySelector('.close');
    const movieForm = document.getElementById('movieForm');
    const modalTitle = document.getElementById('modalTitle');

    const searchForm = document.getElementById('searchForm');


    window.onload = function () {

      fetch(config.api.check_session, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('Token')}`
        }
      })
        .then(response => {
          return {
            status: response.status,
            data: response.json()
          }
        })
        .then(data => data.status === 200 ? getAllMovies() : procesarRespuestaHTTP(data.status))

    };

    function procesarRespuestaHTTP(status) {

      switch (status) {
        case 401:
          //Redirigir a login
          window.location.href = './login.html';
          break;

        case 403:
          //Redirigir a login
          alert('No tienes permiso para realizar esa acción.');
          break;

        default:

          break;
      }
    }

    // Función para cerrar el modal
    function closeMovieModal() {
      movieModal.style.display = 'none';
    }

    // Event listener para el botón "Agregar Película"
    addMovieBtn.addEventListener('click', openMovieModal);
    // Event listener para el botón de cerrar (la "x")
    closeBtn.addEventListener('click', closeMovieModal);
    searchInput.addEventListener('input', (e) => searchMovies(e.target.value));

    /* 
    -
    -
      SECCION DEDICADA A FUNCIONES DE OBTENCION Y RENDERIZACION DE PELICULAS
    -
    -
    */

    async function getAllMovies() {
      try {
        const cachedMovies = localStorage.getItem('cachedMovies');
        const cachedTimestamp = localStorage.getItem('cachedTimestamp');
        const currentTime = new Date().getTime();

        //cacheDuration 15 segundos
        const cacheDuration = 15 * 1000; // 15 segundos
        if (cachedMovies && cachedTimestamp && (currentTime - cachedTimestamp < cacheDuration)) {
          allMovies = JSON.parse(cachedMovies);
          renderMovies(allMovies);
          return;
        }

        const response = await fetch(config.api.getAllMovies, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('Token')}`
          }
        });

        if (!response.ok) throw new Error('Error al cargar las películas');

        const data = await response.json();

        localStorage.setItem('cachedMovies', JSON.stringify(data.movies));
        localStorage.setItem('cachedTimestamp', currentTime.toString());
        renderMovies(data.movies);
      } catch (error) {
        moviesGrid.innerHTML = `
          <div class="no-results">
            <h2>¡Ups! Algo salió mal</h2>
            <p>No pudimos cargar las películas. Por favor intenta de nuevo más tarde.</p>
          </div>
        `;
      } finally {
        loader.style.display = 'none';
      }
    }

    function renderMovies(movies) {
      moviesGrid.innerHTML = '';
      const loggedInUserId = getLoggedInUserId();
      const isUserAdmin = isAdmin();

      movies.forEach(movie => {
        if (!movie) {
          console.error("¡Ojo! Elemento 'movie' es undefined:", movie);
          return;
        }

        const imageUrl = movie.imgUrl || "ERROR AL OBTENER IMAGEN";

        const movieEl = document.createElement('div');
        movieEl.classList.add('movie-card');
        movieEl.innerHTML = `
          <div class="movie-poster">
            <img src="${imageUrl}" alt="${movie.title}" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;300&quot; height=&quot;450&quot; viewBox=&quot;0 0 300 450&quot;><rect width=&quot;100%&quot; height=&quot;100%&quot; fill=&quot;%2321262d&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; font-family=&quot;Arial&quot; font-size=&quot;18&quot; fill=&quot;%238b949e&quot; text-anchor=&quot;middle&quot; dominant-baseline=&quot;middle&quot;>Sin imagen</text></svg>';">
          </div>
          <div class="movie-info">
            <h3 class="movie-title">${movie.title}</h3>
            <div class="movie-details">
              <span class="movie-year">${movie.year || 'Año desconocido'}</span>
              <span class="movie-genre">${movie.genre || 'Sin género'}</span>
            </div>
            ${movie.director ? `<p class="movie-director">Director: ${movie.director}</p>` : ''}
            <div class="movie-actions">
            <div class "movie-description">${movie.description ? `<p class="movie-description">Descripción: ${movie.description}</p>` : ''}</div>
            <div class "movie-rating">${movie.rating ? `<p class="movie-rating">Calificación: ${movie.rating}</p>` : ''}</div>
            <div class "movie-duration">${movie.duration ? `<p class="movie-duration">Duración: ${movie.duration} min</p>` : ''}</div>
              <div class "movie-language">${movie.language ? `<p class="movie-language">Idioma: ${movie.language}</p>` : ''}</div>
              <div class "movie-country">${movie.country ? `<p class="movie-country">País: ${movie.country}</p>` : ''}</div>
              <div class "movie-actors">${movie.cast ? `<p class="movie-actors">Actores: ${movie.cast.join(', ')}</p>` : ''}</div>
            </div>
            <div class="card-actions">
              ${movie.owner ? `<button class="action-btn edit-btn" onclick="handleOpenModalEdit('${movie._id}')" ><i class="fas fa-pencil"></i> Editar</button>` : ''}
              ${movie.owner ? `<button class="action-btn delete-btn"onclick="handleConfirmDeleteMovie('${movie._id}')"  style="margin-top:10px; margin-bottom:10px; " data-movie-id="${movie._id}"><i class="fas fa-trash"></i> Eliminar</button>` : ''}
            </div>
            </div>
          </div>
        `;

        moviesGrid.appendChild(movieEl);
      });

    }



    /*----------------------------------------------------------*/
    /* 
    -
    -
      SECCION DEDICADA A FUNCIONES DE AGREGADO
    -
    -
    */

    // ABRE MODAL DE AGREGAR PELICULA
    function openMovieModal() {
      movieModal.style.display = 'block';
      movieForm.reset(); // Limpiar el formulario
      document.getElementById('movieId').value = ''; // Limpiar el ID en caso de edición futura
      modalTitle.textContent = 'Agregar Nueva Película';
    }

    //AQUI SE AGREGA PELICULA
    movieForm.addEventListener('submit', async (event) => {
      event.preventDefault(); // Evitar la recarga de la página

      // Obtener los valores del formulario

      const movieId = document.getElementById('movieId').value; // Obtener el ID de la película (si existe)

      const isUpdate = movieId !== ''; // Verificar si es una actualización o una nueva película

      const title = document.getElementById('title').value;
      const year = document.getElementById('year').value;
      const director = document.getElementById('director').value; // Obtener el valor del director
      const actors = document.getElementById('cast').value;   // Obtener el valor de los actores
      const imageUrl = document.getElementById('imgUrl').value;
      const description = document.getElementById('description').value;
      const rating = document.getElementById('rating').value;
      const duration = document.getElementById('duration').value;
      const language = document.getElementById('language').value;
      const country = document.getElementById('country').value; // Obtener el valor del país
      const genre = document.getElementById('genre').value; // Obtener el valor del género


      const authToken = localStorage.getItem('Token');
      console.log('Token en la página de películas (authToken - DOMContentLoaded):', authToken);

      if (!authToken) procesarRespuestaHTTP(401);

      const body = {
        title: title,
        year: parseInt(year),
        director: director,       // Incluir el director
        description: description,
        genre: genre,
        rating: parseFloat(rating),
        duration: parseInt(duration),
        language: language,
        country: country, // Incluir el país
        cast: actors, // Cambiar 'cast' a 'actors'
        imgUrl: imageUrl // Incluir la URL de la imagen
      }

      if (isUpdate) {
        body._id = movieId; // Incluir el ID de la película si es una actualización
      }

      const url = isUpdate ? config.api.updateMovie : config.api.addMovie; // URL para agregar o actualizar


      try {
        const response = await fetch(url, {
          method: isUpdate ? 'PUT' : 'POST', // Cambiar a PUT si es una actualización
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}` // Incluir el token en el encabezado Authorization
          },
          body: JSON.stringify({
            ...body
          })
        });

        if (response.status !== 200) {
          procesarRespuestaHTTP(response.status);
          return;
        }

        const responseData = await response.json();

        localStorage.removeItem('cachedMovies');
        localStorage.removeItem('cachedTimestamp');

        //Limpiar movieId
        document.getElementById('movieId').value = '';
        closeMovieModal();
        getAllMovies();
      } catch (error) {
        console.error('Error de red al agregar la película:', error);

      }
    });

    /* ---------------------------------------------------------*/

    /*
    -
    -
      SECCION DEDICADA A FUNCIONES DE AUTHENTICACION Y AUTORIZACION
    -
    -
    */

    function isAdmin() {
      const token = localStorage.getItem('Token');
      if (token) {
        const decodedToken = decodeJwt(token);
        return decodedToken?.role === 'admin';
      }
      return false;
    }

    // Función para obtener el ID del usuario logueado desde el token JWT
    function getLoggedInUserId() {
      const token = localStorage.getItem('Token');
      if (token) {
        const decodedToken = decodeJwt(token);
        return decodedToken?.id || decodedToken?.userId || null; // Asegurarse de que decodedToken no sea null
      }
      return null;
    }

    // Función para decodificar el token JWT
    function decodeJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (error) {
        console.error('Error al decodificar el token:', error);
        return null;
      }
    }

    /*--------------------------------------------------------------*/


    /*
    -
    -
      SECCION DEDICADA A FUNCIONES DE ELIMINACION DE PELICULAS
    -
    - 
    */

    async function handleConfirmDeleteMovie(movieId) {
      const confirmDelete = confirm('¿Estás seguro de que deseas eliminar esta película? Esta acción no se puede deshacer.');
      if (confirmDelete) {
        try {
          const response = await fetch(`${config.api.baseMovie}${movieId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('Token')}`
            }
          });

          if (response.status !== 200) {
            procesarRespuestaHTTP(response.status);
            return;
          }

          const responseData = await response.json();
          showAlert('Película eliminada con éxito', 'success');
          getAllMovies(); // Actualizar la lista de películas después de eliminar
        } catch (error) {
          console.error('Error al eliminar la película:', error);
          showAlert('Error al eliminar la película', 'error');
        }
      }
    }
    /*--------------------------------------------------------------*/


    function showAlert(message, type) {
      const alertBox = document.createElement('div');
      alertBox.className = `alert ${type}`;
      alertBox.textContent = message;
      document.body.appendChild(alertBox);
      setTimeout(() => {
        alertBox.remove();
      }, 3000);
    }

    async function handleOpenModalEdit(id) {
      openMovieModal();
      const movieId = id;
      document.getElementById('movieId').value = movieId; // Guardar el ID de la película en un campo oculto

      const response = await fetch(`http://localhost:3000/api/movies/${movieId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('Token')}`
        }
      });
      if (!response.ok) {
        console.error('Error al obtener la película:', response.statusText);
        return;
      }
      const movieData = await response.json();

      Object.keys(movieData).forEach(key => {
        const input = document.getElementById(key);
        if (input) {
          input.value = movieData[key] || ''; // Asignar el valor al campo correspondiente
        }
      });

    }


    // Buscar películas
    function searchMovies(query) {
      if (query.length < 3) {
        return;
      }
      query = query.toLowerCase().trim();
      const movies = JSON.parse(localStorage.getItem('cachedMovies')) || [];

      const coincidencias = movies.filter(movie => {
        return movie.title.toLowerCase().includes(query) || movie.director.toLowerCase().includes(query) || movie.genre.toLowerCase().includes(query) || movie.description.toLowerCase().includes(query);
      });
      renderMovies(coincidencias);
    }



  </script>
</body>

</html>